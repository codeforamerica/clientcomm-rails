# using terraform to create production ClientComm Environments

This assumes that you have an *existing* heroku team and pipeline, as well as
a staging app from which to promote the initial deploy.

NOTE: All command line examples assume ZSH as the default shell. If you are using
bash substitute `=(command)` with `<(command)`

## Creating a backend

For each production instance of ClientComm you must provide a backend that points
to an s3 terraform backend provider. We use a backend file in lastpass:
```
bucket     = "[YOUR TERRAFORM STATE BUCKET]"
region     = "[REGION]"
access_key = "[ACCESS KEY]"
secret_key = "[SECRET KEY]"
```

On the command line, use the `terraform init` command to point to this backend
and specify the key, or environment name, of the deployment you're managing
```bash
terraform init -backend-config =(lpass show --notes terraform-backend) -backend-config 'key=[DEPLOYMENT NAME]'
```

## Prepping a Twilio account

In Twilio, create a new subaccount if you use them to manage your deploys, then buy a
phone number in the appropriate area code. Configure the _A CALL COMES IN_ webhook
to point to `https://[DEPLOYMENT NAME].clientcomm.org/incoming/voice/` and the _A MESSAGE COMES IN_
webhook to point to `https://[DEPLOYMENT NAME].clientcomm.org/incoming/sms/`.

On the [Alert Triggers](https://www.twilio.com/console/runtime/triggers/alert/create) page, set up
the following triggers to email `clientcomm-alerts@codeforamerica.org`:

* Trigger on ANY alert, at value 1 (First alert of the day)
* Trigger on ANY alert, at value 10 (Alert after 10 issues in a single day)

## Set up Pingdom

On [Pingdom](https://my.pingdom.com/newchecks/checks), create a new uptime check to point to the
new deploy's front page. It should check once a minute and alert Mikela and Tomas; it should alert
after 2 minutes down; and the Slack webhook integration should be checked.

## Managing a ClientComm deployment
Create a var-file in lastpass called clientcomm-personal-terraform-secrets with this content:

```
aws_access_key = "[your personal access key]"
aws_secret_key = "[your personal secret access key]"
```


Once you have set your backend you are ready to manage a production deployment.
We use a var-file in lastpass to contain secrets and specific configuration
for each deployment:
```
mailgun_api_key = ""
mailgun_domain = ""
mailgun_smtp_password = ""
mailgun_require_dkim = ""
papertrail_plan = ""

route53_email_zone_id = ""
route53_app_zone_id = ""

heroku_email = ""
heroku_api_key = ""
heroku_app_name = ""
app_domain = ""
heroku_pipeline_id = ""
heroku_team = ""

unclaimed_email = ""
unclaimed_password = ""

papertrail_plan = ""

admin_email = ""
admin_password = ""
devise_secret_key_base = ""

sentry_deploy_hook = ""

intercom_app_id = ""
intercom_secret_key = ""
mixpanel_token = ""
sentry_endpoint = ""
skylight_authentication = ""
time_zone = ""
twilio_account_sid = ""
twilio_auth_token = ""
twilio_phone_number = ""
typeform_link = ""
report_day = ""
```

While most of these variables may be self explanatory there are a few details
that need further explanation:
* the route53 app zone ID variable should point to a zone file that hosts the
main domain you wish to use for your deployments. This will be used to create
the [deployment].[main_domain].tld CNAME record in your route53 zone that points
at heroku
* the route53 email zone ID variable behaves largely the same as app zone ID
but is used to create the proper mx and TXT (for SPIF and DKIM) records for sending
email with mailgun, as HSTS prevents us from sharing a domain across the app and mailgun.
* currently due to the behavior of the heroku provider you must provide an email
associated with a heroku account that has access to the pipeline you want to use.
* `devise_secret_key_base` must be set to a value generated by `rake secret`

The variables that will definitely need to change between deploys are: `mailgun_domain`,
`heroku_app_name`, `app_domain`, `time_zone`, `twilio_account_sid`, `twilio_auth_token`,
and `twilio_phone_number`.

Once you have created and saved the var file in lastpass you are ready to deploy:
```bash
terraform plan -var-file =(lpass show --notes [YOUR VAR FILE]) --var-file =(lpass show --notes clientcomm-personal-terraform-secrets)
```

If you believe the plan accurately reflects the changes or additions you wish
to make you are ready to run apply:
```bash
terraform apply -var-file =(lpass show --notes [YOUR VAR FILE])
```

There is a manual step during the deploy; the [Heroku Scheduler](https://devcenter.heroku.com/articles/scheduler) interface will
launch. Add two jobs; one for the Twilio status update rake task to run every 10 minutes:

```
rake messages:update_twilio_statuses
```

And one for the usage report rake task to run every day:

```
rake reports:generate_and_send_reports
```

Although that task will run daily, it'll only send when the day of the week matches
the value of the `report_day` variable mentioned above, with Sunday = "0" and
Saturday = "6".

Once the deploy is finished, start up a rails console on the remote server with the
Heroku CLI:

```bash
heroku run rails c --app [APP-NAME]
```

Then create an admin user:

```
AdminUser.create(email: '[USER EMAIL]', password: '[PASSWORD]', password_confirmation: '[PASSWORD]')
```

If you're working on a team, put the login credentials in a shared password manager
so that your teammates can create new user and admin user accounts.

You'll also need to log in to mailgun to verify the email domain. Click on the
*Domains* menu, click the new domain that was just created, and click the *Check DNS Records Now*
button.

If you have a help page for your deploy, you can add a link to it in the menu bar by
setting the `HELP_LINK` config variable like so:

```bash
heroku set:config HELP_LINK='https://example.com/'
```
