<% content_for(:template_name) { "messages" }  %>

<section class="slab slab--header">
  <div class="grid">
    <div class="grid__item">
      <h2 class="client-name"><%= @client.full_name %></h2>
      <%= link_to "Edit client", edit_client_path(@client), {class: 'button button--small' } %>
    </div>
    <span class="text--help is-mobile-hidden--inline"><%= phone_number_display(@client.phone_number) %></span>
  </div>
</section>

<section class="slab slab--padded slab--borderless" id="scroller-target">
  <div id="message-list" class="message--container grid" data-client-id="<%= @client.id %>">
    <%= render @messages %>
  </div>
</section>

<section class="message--create">
  <div class="grid">
    <% if @messages_scheduled.count > 0 %>
      <div class="scheduled-messages-bar">
        <%= render "scheduled_messages_link", count: @messages_scheduled.count, client: @client %>
      </div>
    <% end %>
  </div>

  <div class="sendbar">
    <div class="grid">
      <%= form_for Message.new, remote: true do |f| %>
        <input name="client_id" type="hidden" value="<%= @client.id %>">

        <div class="grid__item width-two-thirds-lg">
          <%= f.text_field(:body, { autofocus: true, type: 'text', class: 'sendbar__input main-message-input', autocomplete: 'off', autocorrect: 'off', autocapitalize: 'off', placeholder: 'Send a text message' }) %>
        </div>
        <div class="grid__item width-one-third-lg">
          <button id="send_message" class="sendbar__button button--primary" type="submit">Send</button>

          <% if feature_flags.scheduled_messages %>
            <button id="send_later" class="sendbar__button" data-toggle="modal" type="button" data-target="#send-later-modal">Send later</button>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</section>

<div class="modal fade" id="send-later-modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h2 class="form-card__title" id="myModalLabel">Send message later</h2>
      </div>
      <%= form_for @message, builder: GcfFormBuilder, namespace: 'scheduled' do |f| %>
        <input name="client_id" type="hidden" value="<%= @client.id %>">
        <div class="modal-body">
          <%= f.gcf_textarea(:body, 'Your message', classes: ['send-later-input'], placeholder: 'Your message text', autofocus: true) %>
          <fieldset class="form-group">
            <label for="scheduled_message_send_at_date">
              <p class="form-question">Date</p>
            </label>
            <input type="text" name="message[send_at_date]" id="scheduled_message_send_at_date" />
            <label for="scheduled_message_send_at_time">
              <p class="form-question">Time</p>
            </label>
            <select name="message[send_at_time]" id="scheduled_message_send_at_time">
              <%
                  start = Time.now.change(min: 0, hour: 0)
                  times = []
                  48.times do
                    times << start
                    start += 30.minutes
                  end
              %>
              <% times.each_with_index do |time, i| %>
                <option <%= "selected" if i == 19 %> value="<%= time.strftime('%-l:%M%P') %>"><%= time.strftime('%-l:%M%P') %></option>
              <% end %>
            </select>
          </fieldset>
        </div>
        <div class="modal-footer">
          <button id="schedule-message" type="submit" class="button button--primary">Schedule message</button>
          <button type="button" class="button" data-dismiss="modal">Cancel</button>
        </div>
      <% end %>
    </div>
  </div>
</div>
